<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸€ç«™å¼é‡‘èè¦åŠƒå·¥å…·</title>
    <!-- è¼‰å…¥ Tailwind CSS (CSS/æ¨£å¼) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Chart.js è¦–è¦ºåŒ–åœ–è¡¨åº« (å¤–éƒ¨è³‡æº) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* è‡ªå®šç¾© CSS ä¾†è¨­å®šå­—é«”å’ŒèƒŒæ™¯ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* æŸ”å’Œçš„æ·ºè—ç°è‰²èƒŒæ™¯ */
        }
        /* ç¢ºä¿ Chart.js Canvas éŸ¿æ‡‰å¼ */
        .chart-container {
            height: 300px; 
            width: 100%;
            margin-top: 1.5rem;
        }
        /* éš±è—åŸç”Ÿæ•¸å­—è¼¸å…¥çš„ç®­é ­ */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10">
        <h1 class="text-4xl font-extrabold text-center mb-10 text-indigo-700">
            ğŸ“Š å€‹äººè²¡å‹™è¦åŠƒä¸­å¿ƒ
        </h1>

        <!-- ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º (é‡è¦ï¼šç”¨æ–¼å¤šäººå”ä½œèˆ‡è³‡æ–™åº«é©—è­‰) -->
        <p id="user-info" class="text-xs text-gray-500 text-right mb-4"></p>

        <!-- ç¸½é«”ç¶²æ ¼ä½ˆå±€ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- A. è¤‡åˆ©è¨ˆç®—æ©Ÿ (ä½” 1 æ¬„) -->
            <div id="calculator-panel" class="lg:col-span-1 p-6 bg-indigo-50 rounded-lg shadow-md border border-indigo-200">
                <h2 class="text-2xl font-bold mb-6 text-indigo-800 border-b pb-2">ğŸ“ˆ æ¯æœˆè¤‡åˆ©è¨ˆç®—æ©Ÿ</h2>
                
                <div class="space-y-4">
                    <!-- åˆå§‹æœ¬é‡‘, æ¯æœˆæŠ•å…¥é‡‘é¡, å¹´åŒ–å ±é…¬ç‡, æŠ•è³‡å¹´é™... (ç•¥ï¼Œä¿æŒä¸è®Š) -->
                    <div class="input-group">
                        <label for="initial-principal" class="block text-sm font-medium text-gray-700">åˆå§‹æœ¬é‡‘ (P) $</label>
                        <input type="number" id="initial-principal" value="10000" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="input-group">
                        <label for="monthly-contribution" class="block text-sm font-medium text-gray-700">æ¯æœˆå®šæœŸæŠ•å…¥é‡‘é¡ (M) $</label>
                        <input type="number" id="monthly-contribution" value="5000" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="input-group">
                        <label for="annual-rate" class="block text-sm font-medium text-gray-700">é æœŸå¹´åŒ–å ±é…¬ç‡ (r) %</label>
                        <input type="number" id="annual-rate" value="6" min="0" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="input-group">
                        <label for="years" class="block text-sm font-medium text-gray-700">æŠ•è³‡å¹´é™ (n) å¹´</label>
                        <input type="number" id="years" value="20" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                </div>

                <button onclick="calculateCompoundInterest()" class="w-full mt-6 py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition duration-300">
                    è¨ˆç®—æœ€çµ‚è³‡ç”¢åƒ¹å€¼
                </button>

                <div id="result-display" class="mt-6 p-4 bg-white border border-green-300 rounded-md shadow-inner hidden">
                    <!-- è¨ˆç®—çµæœé¡¯ç¤ºåœ¨é€™è£¡ -->
                </div>
            </div>

            <!-- B. è³‡ç”¢é…ç½®è¿½è¹¤å™¨ (ä½” 2 æ¬„) -->
            <div id="allocation-panel" class="lg:col-span-2 p-6 bg-yellow-50 rounded-lg shadow-md border border-yellow-200">
                <h2 class="text-2xl font-bold mb-6 text-yellow-800 border-b pb-2">ğŸ“Š è³‡ç”¢é…ç½®è¿½è¹¤</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- è¼¸å…¥å€ (ç•¥ï¼Œä¿æŒä¸è®Š) -->
                    <div>
                        <div id="allocation-inputs" class="space-y-3">
                            <div class="flex space-x-2 allocation-row">
                                <input type="text" class="asset-name p-2 border rounded-md w-1/2" value="ç¾åœ‹è‚¡ç¥¨ (S&P)" placeholder="è³‡ç”¢åç¨±">
                                <input type="number" class="asset-percent p-2 border rounded-md w-1/4" value="60" min="0" max="100" placeholder="%">
                                <button class="remove-btn bg-red-500 text-white p-2 rounded-md w-1/4 hover:bg-red-600" onclick="removeAsset(this)">ç§»é™¤</button>
                            </div>
                            <div class="flex space-x-2 allocation-row">
                                <input type="text" class="asset-name p-2 border rounded-md w-1/2" value="å°ç£è‚¡ç¥¨ (ETF)" placeholder="è³‡ç”¢åç¨±">
                                <input type="number" class="asset-percent p-2 border rounded-md w-1/4" value="30" min="0" max="100" placeholder="%">
                                <button class="remove-btn bg-red-500 text-white p-2 rounded-md w-1/4 hover:bg-red-600" onclick="removeAsset(this)">ç§»é™¤</button>
                            </div>
                            <div class="flex space-x-2 allocation-row">
                                <input type="text" class="asset-name p-2 border rounded-md w-1/2" value="ç¾é‡‘/å‚µåˆ¸" placeholder="è³‡ç”¢åç¨±">
                                <input type="number" class="asset-percent p-2 border rounded-md w-1/4" value="10" min="0" max="100" placeholder="%">
                                <button class="remove-btn bg-red-500 text-white p-2 rounded-md w-1/4 hover:bg-red-600" onclick="removeAsset(this)">ç§»é™¤</button>
                            </div>
                        </div>
                        <button id="add-asset-btn" onclick="addAssetInput()" class="w-full mt-4 py-2 bg-yellow-400 text-yellow-900 font-semibold rounded-lg hover:bg-yellow-500 transition duration-300">
                            + æ–°å¢è³‡ç”¢é¡åˆ¥
                        </button>
                        <button onclick="updateAllocationChart()" class="w-full mt-2 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition duration-300">
                            æ›´æ–°é…ç½®åœ“é¤…åœ–
                        </button>
                        <p id="total-percent" class="text-center font-bold mt-3 text-lg"></p>
                    </div>
                    
                    <!-- åœ–è¡¨å€ (ç•¥ï¼Œä¿æŒä¸è®Š) -->
                    <div>
                        <div class="chart-container">
                            <canvas id="allocation-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- C. è‚¡ç¥¨å¿«é€Ÿé€£çµ (ä½”æ‰€æœ‰æ¬„ä½ - æ–°å¢è¼¸å…¥åŠŸèƒ½) -->
            <div id="finance-panel" class="lg:col-span-3 p-6 bg-green-50 rounded-lg shadow-md border border-green-200">
                <h2 class="text-2xl font-bold mb-6 text-green-800 border-b pb-2">ğŸ”— å¯¦æ™‚è§€å¯Ÿæ¸…å–® (å¯è‡ªè¨‚)</h2>

                <!-- æ–°å¢è‚¡ç¥¨è¼¸å…¥å€ -->
                <div class="flex flex-col md:flex-row gap-2 mb-6 p-4 bg-green-100 rounded-lg shadow-inner">
                    <input type="text" id="new-stock-symbol" class="p-3 border rounded-md flex-grow" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼Œä¾‹å¦‚: TPE:2330 æˆ– NASDAQ:GOOG">
                    <input type="text" id="new-stock-name" class="p-3 border rounded-md flex-grow" placeholder="è¼¸å…¥è‚¡ç¥¨åç¨±ï¼Œä¾‹å¦‚: å°ç©é›» æˆ– Google">
                    <button onclick="addNewStock()" class="py-3 px-6 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-300 whitespace-nowrap">
                        æ–°å¢è‡³æ¸…å–®
                    </button>
                </div>
                
                <p class="text-sm text-gray-600 mb-4">é»æ“Šåç¨±å°‡åœ¨æ–°è¦–çª—ä¸­å°å‘ Google è²¡ç¶“ï¼Œé»æ“Š **[X]** å³å¯å¾æ¸…å–®ä¸­ç§»é™¤ã€‚</p>
                
                <!-- å¯¦æ™‚é€£çµé¡¯ç¤ºå€ -->
                <div id="stock-links" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <!-- é€£çµå°‡é€é Firestore æ•¸æ“šå¯¦æ™‚è¼‰å…¥ -->
                </div>
            </div>
        </div>
    </div>

<!-- Firebase SDKs for Authentication and Firestore -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, query, orderBy, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // è¨­ç½® Firebase å…¨åŸŸè®Šæ•¸
    let app, db, auth, userId;
    let isAuthReady = false;

    // Canvas æä¾›çš„å…¨åŸŸè®Šæ•¸ (è«‹å‹¿ä¿®æ”¹é€™ä¸‰å€‹è®Šæ•¸)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-finance-app';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- Firebase åˆå§‹åŒ– ---
    async function initFirebase() {
        if (!firebaseConfig) {
            console.error("Firebase Configuration is missing.");
            return;
        }

        try {
            // 1. åˆå§‹åŒ– Firebase æœå‹™
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug'); // å•Ÿç”¨ Firetore Debug Log

            // 2. è™•ç†èº«ä»½é©—è­‰
            if (initialAuthToken) {
                // ä½¿ç”¨æä¾›çš„ Token ç™»å…¥ (Canvas ç’°å¢ƒ)
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                // å¦‚æœæ²’æœ‰ Tokenï¼Œå‰‡ä½¿ç”¨åŒ¿åç™»å…¥ (ä¸€èˆ¬éœæ…‹è¨—ç®¡ç’°å¢ƒ)
                await signInAnonymously(auth);
            }

            // 3. ç›£è½èº«ä»½é©—è­‰ç‹€æ…‹è®ŠåŒ–
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    // é¡¯ç¤ºç”¨æˆ¶ ID
                    document.getElementById('user-info').textContent = `æ‚¨çš„ç”¨æˆ¶ID: ${userId} (æ­¤æ¸…å–®ç‚ºç§æœ‰)`; 
                    
                    // 4. èº«ä»½é©—è­‰å®Œæˆå¾Œï¼Œé–‹å§‹ç›£è½è³‡æ–™åº«
                    startWatchlistListener();
                } else {
                    isAuthReady = true;
                    userId = crypto.randomUUID(); // æœªç™»å…¥ä¹Ÿçµ¦ä¸€å€‹éš¨æ©Ÿ ID
                    document.getElementById('user-info').textContent = `ç”¨æˆ¶ç‹€æ…‹: æœªé©—è­‰ (ID: ${userId})`;
                }
            });

        } catch (error) {
            console.error("Firebase Initialization Error:", error);
        }
    }

    // --- Firestore è·¯å¾‘å®šç¾© ---
    // ä½¿ç”¨ç§äººè·¯å¾‘ï¼Œç¢ºä¿æ¯å€‹ç”¨æˆ¶åªèƒ½çœ‹åˆ°è‡ªå·±çš„è§€å¯Ÿæ¸…å–®
    // è·¯å¾‘çµæ§‹: /artifacts/{appId}/users/{userId}/stock_watchlist
    const watchlistPath = (uid) => `artifacts/${appId}/users/${uid}/stock_watchlist`; 

    // --- å¯¦æ™‚ç›£è½è§€å¯Ÿæ¸…å–® ---
    function startWatchlistListener() {
        if (!db || !isAuthReady || !userId) return;

        // ä½¿ç”¨ç§äººè·¯å¾‘
        const stockCollectionRef = collection(db, watchlistPath(userId)); // <-- å‚³å…¥ userId
        
        // å¯¦æ™‚ç›£è½ (onSnapshot)
        onSnapshot(stockCollectionRef, (snapshot) => {
            const stocks = [];
            snapshot.forEach(doc => {
                stocks.push({ id: doc.id, ...doc.data() });
            });
            
            // å°‡ç²å–çš„ stocks åˆ—è¡¨å‚³éçµ¦æ¸²æŸ“å‡½æ•¸
            renderStockLinks(stocks);
        }, (error) => {
            console.error("Error listening to watchlist:", error);
            // å¯ä»¥åœ¨é€™è£¡é¡¯ç¤ºä¸€å€‹ UI éŒ¯èª¤æç¤ºçµ¦ç”¨æˆ¶
        });
    }

    // --- æ–°å¢è‚¡ç¥¨åˆ° Firestore ---
    window.addNewStock = async function() {
        if (!db || !isAuthReady || !userId) {
            console.error("Database or User is not ready.");
            return;
        }

        const symbolInput = document.getElementById('new-stock-symbol');
        const nameInput = document.getElementById('new-stock-name');
        
        const symbol = symbolInput.value.trim().toUpperCase();
        const name = nameInput.value.trim();

        if (!symbol) {
            // ç‚ºäº†é¿å… confirm å½ˆçª—é€ æˆç’°å¢ƒä¸­æ–·ï¼Œé€™è£¡æ”¹ç‚ºæ§åˆ¶å°è­¦å‘Š
            console.warn('è«‹è¼¸å…¥æœ‰æ•ˆçš„è‚¡ç¥¨ä»£ç¢¼ï¼'); 
            return;
        }
        
        // ç¢ºä¿ç¬¦è™Ÿæ˜¯ Google è²¡ç¶“æ ¼å¼ (ä¾‹å¦‚: TPE:2330 æˆ– NASDAQ:GOOG)
        if (!symbol.includes(':')) {
            // ç‚ºäº†é¿å… confirm å½ˆçª—é€ æˆç’°å¢ƒä¸­æ–·ï¼Œé€™è£¡æ”¹ç‚ºæ§åˆ¶å°è­¦å‘Š
            console.warn('è‚¡ç¥¨ä»£ç¢¼æ ¼å¼æ‡‰ç‚º [äº¤æ˜“æ‰€:ä»£ç¢¼]ï¼Œä¾‹å¦‚ NASDAQ:GOOG æˆ– TPE:2330ã€‚');
            return;
        }

        try {
            // ä½¿ç”¨ç§äººè·¯å¾‘
            const stockCollectionRef = collection(db, watchlistPath(userId)); // <-- å‚³å…¥ userId
            await addDoc(stockCollectionRef, {
                symbol: symbol,
                name: name || symbol, // å¦‚æœåç¨±ç‚ºç©ºï¼Œå‰‡ä½¿ç”¨ä»£ç¢¼
                userId: userId, // è¨˜éŒ„æ˜¯èª°æ–°å¢çš„ (é›–ç„¶åœ¨ç§äººæ¸…å–®ä¸­ï¼Œä½†ä¾ç„¶æ˜¯å€‹å¥½çš„è¨˜éŒ„ç¿’æ…£)
                timestamp: Date.now()
            });

            // æ¸…ç©ºè¼¸å…¥æ¬„ä½
            symbolInput.value = '';
            nameInput.value = '';

        } catch (e) {
            console.error("Error adding stock:", e);
        }
    }

    // --- å¾ Firestore åˆªé™¤è‚¡ç¥¨ ---
    window.removeStock = async function(docId) {
        if (!db || !isAuthReady || !userId) {
            console.error("Database or User is not ready.");
            return;
        }
        
        // ç‚ºäº†é¿å… confirm å½ˆçª—åœ¨ iFrame ç’°å¢ƒä¸­é€ æˆå•é¡Œï¼Œé€™è£¡å°‡ç›´æ¥åŸ·è¡Œåˆªé™¤æ“ä½œã€‚
        try {
            // ä½¿ç”¨ç§äººè·¯å¾‘
            const docRef = doc(db, watchlistPath(userId), docId); // <-- å‚³å…¥ userId
            await deleteDoc(docRef);
        } catch (e) {
            console.error("Error deleting stock:", e);
        }
    }

    // --- C. è‚¡ç¥¨å¿«é€Ÿé€£çµæ¸²æŸ“åŠŸèƒ½ (ç¾åœ¨å¾ Firestore æ•¸æ“šæ¸²æŸ“) ---
    function generateFinanceUrl(symbol) {
        return `https://www.google.com/finance/quote/${symbol}`;
    }
    
    function renderStockLinks(stocks) {
        const container = document.getElementById('stock-links');
        if (!container) return; 

        let htmlContent = '';

        stocks.forEach(stock => {
            const url = generateFinanceUrl(stock.symbol);
            htmlContent += `
                <div class="p-4 bg-white rounded-lg shadow hover:shadow-lg transition duration-200 flex items-center justify-between border border-green-300">
                    <a class="stock-link flex-grow text-left pr-2" 
                       href="${url}" 
                       target="_blank" 
                       title="é»æ“Šå‰å¾€ Google è²¡ç¶“">
                        <span class="text-xl font-extrabold text-green-700 block">${stock.symbol.split(':')[1] || stock.symbol}</span>
                        <span class="text-sm text-gray-500 block">${stock.name}</span>
                    </a>
                    <button class="text-red-500 hover:text-red-700 font-bold text-lg p-1" 
                            onclick="removeStock('${stock.id}')"
                            title="ç§»é™¤æ­¤è‚¡ç¥¨">
                        &times;
                    </button>
                </div>
            `;
        });
        
        container.innerHTML = htmlContent;
    }

    // åˆå§‹åŒ– Firebase
    initFirebase();
</script>

<script>
    // --- è¤‡åˆ©è¨ˆç®—åŠŸèƒ½ (ä¿æŒä¸è®Š) ---
    function calculateCompoundInterest() {
        const P = parseFloat(document.getElementById('initial-principal').value) || 0; 
        const M_monthly = parseFloat(document.getElementById('monthly-contribution').value) || 0; 
        const r_percent = parseFloat(document.getElementById('annual-rate').value) || 0; 
        const n_years = parseInt(document.getElementById('years').value) || 0; 
        
        const r_monthly = (r_percent / 100) / 12; 
        const N_months = n_years * 12; 
        
        let FV_P = P * Math.pow(1 + r_monthly, N_months);
        
        let FV_M = 0;
        if (r_monthly === 0) {
            FV_M = M_monthly * N_months;
        } else {
            const factor = (Math.pow(1 + r_monthly, N_months) - 1) / r_monthly;
            FV_M = M_monthly * factor * (1 + r_monthly);
        }

        const FV = FV_P + FV_M; 
        const totalPrincipal = P + (M_monthly * N_months); 
        const totalInterest = FV - totalPrincipal; 
        
        const formatter = new Intl.NumberFormat('en-US', { 
            style: 'currency', 
            currency: 'USD', 
            minimumFractionDigits: 2, 
            maximumFractionDigits: 2 
        });
        const resultDisplay = document.getElementById('result-display');
        
        resultDisplay.innerHTML = `
            <div class="space-y-2">
                <p class="text-sm text-gray-700">ç¸½æŠ•è³‡æœŸæ•¸ï¼š<span class="font-bold">${N_months} å€‹æœˆ (${n_years} å¹´)</span></p>
                <p class="text-sm text-gray-700">ç¸½æŠ•å…¥æœ¬é‡‘ï¼š<span class="font-bold text-indigo-600">${formatter.format(totalPrincipal)}</span></p>
                <p class="text-lg font-extrabold text-green-700">æœ€çµ‚è³‡ç”¢ç¸½å€¼ (FV)ï¼š<span class="text-2xl">${formatter.format(FV)}</span></p>
                <p class="text-sm text-gray-700">ç¸½ç²åˆ©/åˆ©æ¯ï¼š<span class="font-bold text-green-600">${formatter.format(totalInterest)}</span></p>
            </div>
        `;
        resultDisplay.classList.remove('hidden');
    }

    // --- è³‡ç”¢é…ç½®åŠŸèƒ½ (ä¿æŒä¸è®Š) ---
    let allocationChart = null; 
    
    function getChartContext() {
        const canvas = document.getElementById('allocation-chart');
        return canvas ? canvas.getContext('2d') : null;
    }

    window.addAssetInput = function() { 
        const container = document.getElementById('allocation-inputs');
        const newRow = document.createElement('div');
        newRow.classList.add('flex', 'space-x-2', 'allocation-row');
        newRow.innerHTML = `
            <input type="text" class="asset-name p-2 border rounded-md w-1/2" placeholder="è³‡ç”¢åç¨±">
            <input type="number" class="asset-percent p-2 border rounded-md w-1/4" min="0" max="100" placeholder="%">
            <button class="remove-btn bg-red-500 text-white p-2 rounded-md w-1/4 hover:bg-red-600" onclick="removeAsset(this)">ç§»é™¤</button>
        `;
        container.appendChild(newRow);
    }
    
    window.removeAsset = function(buttonElement) { 
        const row = buttonElement.parentNode; 
        row.parentNode.removeChild(row); 
        updateAllocationChart(); 
    }
    
    window.updateAllocationChart = function() { 
        try {
            if (typeof Chart === 'undefined') {
                console.warn("Chart.js å°šæœªè¼‰å…¥ï¼Œç„¡æ³•ç¹ªè£½åœ–è¡¨ã€‚");
                return;
            }

            const ctx = getChartContext();
            if (!ctx) {
                console.error("Canvas å…ƒç´ æˆ– Context æœªæ‰¾åˆ°ã€‚");
                return;
            }

            const names = Array.from(document.querySelectorAll('.asset-name')).map(input => input.value || 'æœªå‘½å');
            const percentages = Array.from(document.querySelectorAll('.asset-percent')).map(input => parseFloat(input.value) || 0);
            const totalPercent = percentages.reduce((sum, p) => sum + p, 0);
            
            const totalPercentDisplay = document.getElementById('total-percent');
            totalPercentDisplay.textContent = `ç¸½æ¯”ä¾‹: ${totalPercent.toFixed(1)}%`;
            totalPercentDisplay.className = totalPercentDisplay.className.replace(/text-[\w-]+/, totalPercent.toFixed(1) === '100.0' ? 'text-green-600' : 'text-red-600');
            
            if (percentages.length === 0 || totalPercent === 0) { 
                if (allocationChart) { allocationChart.destroy(); allocationChart = null; } 
                return; 
            }
            
            const generateColors = (count) => { 
                const colors = []; 
                for (let i = 0; i < count; i++) { 
                    const hue = (i * 137.508) % 360; 
                    colors.push(`hsl(${hue}, 70%, 50%)`); 
                } 
                return colors; 
            };
            const backgroundColors = generateColors(percentages.length);
            
            const data = { 
                labels: names, 
                datasets: [{ 
                    data: percentages, 
                    backgroundColor: backgroundColors, 
                    hoverOffset: 8,
                    borderRadius: 5
                }] 
            };
            
            const config = { 
                type: 'doughnut', 
                data: data, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { 
                            position: 'right', 
                        }, 
                        title: { 
                            display: true, 
                            text: 'ç•¶å‰è³‡ç”¢é…ç½®åœ“é¤…åœ–', 
                            font: { size: 18 } 
                        } 
                    } 
                } 
            };
            
            if (allocationChart) { allocationChart.destroy(); }
            allocationChart = new Chart(ctx, config);

        } catch (e) {
            console.error("è³‡ç”¢é…ç½®åœ–è¡¨åˆå§‹åŒ–éŒ¯èª¤:", e);
        }
    }
    
    // --- é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ ---
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            updateAllocationChart(); 
        }, 100); 
    });
</script>

</body>
</html>
